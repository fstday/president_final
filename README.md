# Интеграция OpenAI Assistant с системой записи на прием

Этот модуль предоставляет интеграцию между голосовым роботом ACS и системой записи на прием InfoClinica через OpenAI Assistant API.

## Архитектура решения

1. **ACS Голосовой робот**: Обрабатывает голосовые запросы пациентов и отправляет их в виде текста на наш API
2. **API эндпоинт**: Принимает текстовые запросы и данные о записи на прием, передает их ассистенту OpenAI
3. **OpenAI Assistant**: Анализирует запрос и определяет намерение пациента
4. **Function Calling**: Вызывает соответствующие функции для взаимодействия с InfoClinica
5. **Форматирование ответа**: Форматирует ответ в соответствии с документацией ACS

## Установка

1. Добавьте необходимые зависимости:
```bash
pip install -r requirements.txt
```

2. Настройте переменные окружения:
```
OPEN_AI_API_KEY=ваш_ключ_api_openai
```

3. Добавьте приложение в `INSTALLED_APPS` в `settings.py`:
```python
INSTALLED_APPS = [
    # ...
    'reminder',
    # ...
]
```

4. Создайте ассистента с помощью команды управления:
```bash
python manage.py create_assistant --name "Медицинский ассистент" --model "gpt-4-mini"
```

## Использование API

### Эндпоинт для обработки запросов от голосового робота

```
POST /voicebot/infoclinica-clinic/v1/
```

#### Параметры запроса:
```json
{
  "appointment_id": 123456,
  "user_input": "Хочу перенести запись на завтра"
}
```

#### Пример успешного ответа:
```json
{
  "status": "success_change_reception",
  "date": "29 Января",
  "date_kz": "29 Қаңтар",
  "specialist_name": "Иванов И.И.",
  "weekday": "Пятница",
  "weekday_kz": "Жұма",
  "time": "10:30"
}
```

### Эндпоинт для создания/обновления ассистента

```
POST /api/assistants/create/
```

#### Параметры запроса:
```json
{
  "name": "Медицинский ассистент",
  "instructions": "Текст инструкций для ассистента",
  "model": "gpt-4-mini"
}
```

### Эндпоинт для получения информации об ассистентах

```
GET /api/assistants/info/
```

## Форматы возвращаемых ответов

### Успешный перенос записи
```json
{
  "status": "success_change_reception",
  "date": "29 Января",
  "date_kz": "29 Қаңтар",
  "specialist_name": "Иванов И.И.",
  "weekday": "Пятница",
  "weekday_kz": "Жұма",
  "time": "10:30"
}
```

### Запрос доступных времен
```json
{
  "status": "which_time",
  "date": "29 Января",
  "date_kz": "29 Қаңтар",
  "specialist_name": "Иванов И.И.",
  "weekday": "Пятница",
  "weekday_kz": "Жұма",
  "first_time": "10:00",
  "second_time": "11:00",
  "third_time": "12:00"
}
```

### Успешное удаление записи
```json
{
  "status": "success_deleting_reception",
  "message": "Запись успешно удалена"
}
```

### Ошибка удаления
```json
{
  "status": "error_deleting_reception",
  "message": "Причина ошибки удаления"
}
```

### Общая ошибка
```json
{
  "status": "error",
  "message": "Описание общей ошибки"
}
```

## Доступные функции для ассистента

1. `delete_appointment` - удаляет запись на прием
2. `reserve_appointment` - создает или меняет запись на прием
3. `get_appointment_time` - получает информацию о текущей записи
4. `get_available_times` - получает доступные времена для записи

## Дополнительная информация

- **Тайм-аут ответа**: По умолчанию установлен на 60 секунд
- **Обработка ошибок**: Все ошибки логируются в журнал приложения
- **Автоматическое обновление статуса**: Статус запуска ассистента обновляется в БД

## Примеры запросов, которые может обрабатывать ассистент

1. "Хочу записаться на прием завтра"
2. "Мне нужно отменить запись"
3. "Какое время у меня завтра запись?"
4. "Хочу перенести запись на другое время"
5. "Какие есть свободные окна на четверг?"